delete from PROD_DNA_CORE.DBT_CLOUD_PR_5458_1220.NTAWKS_INTEGRATION__WKS_TW_RPT_RE;

insert into PROD_DNA_CORE.DBT_CLOUD_PR_5458_1220.NTAWKS_INTEGRATION__WKS_TW_RPT_RE (

with wks_tw_re_msl_list as (
    select * from PROD_DNA_CORE.DBT_CLOUD_PR_5458_1220.NTAWKS_INTEGRATION__WKS_TW_RE_MSL_LIST
),
wks_tw_re_actuals as (
    select * from PROD_DNA_CORE.DBT_CLOUD_PR_5458_1220.NTAWKS_INTEGRATION__WKS_TW_RE_ACTUALS
),
customer_heirarchy as (
    select * from PROD_DNA_CORE.aspedw_integration.edw_generic_customer_hierarchy
),
product_heirarchy as (
    select * from PROD_DNA_CORE.aspedw_integration.edw_generic_product_hierarchy
),
edw_company_dim as (
    select * from PROD_DNA_CORE.aspedw_integration.edw_company_dim
),
edw_vw_pop6_products as (
    --select * from {{ source('ntaedw_integration', 'edw_vw_pop6_products') }}
    select * from PROD_DNA_CORE.aspedw_integration.edw_vw_pop6_products
),

TW_RPT_RE_mdp AS (
SELECT distinct Q.*,
       COM.*
FROM (SELECT TARGET.jj_year::numeric(18,0) as jj_year,
             TARGET.jj_mnth_id::numeric(18,0) as jj_mnth_id,		 
             --TARGET.market AS MARKET,
             COALESCE(ACTUAL.CNTRY_NM, TARGET.MARKET) AS MARKET,
             COALESCE(ACTUAL.CHANNEL_NAME,TARGET.Sell_Out_Channel,'NA') as CHANNEL_NAME,
             COALESCE(ACTUAL.SOLDTO_CODE, TARGET.SOLDTO_CODE) AS SOLDTO_CODE,
             COALESCE(actual.DISTRIBUTOR_CODE,TARGET.DISTRIBUTOR_CODE,'NA') as DISTRIBUTOR_CODE,
             COALESCE(actual.DISTRIBUTOR_NAME,TARGET.DISTRIBUTOR_NAME,'NA') as DISTRIBUTOR_NAME,
             COALESCE(actual.CHANNEL_NAME,TARGET.SELL_OUT_CHANNEL,'NA') as SELL_OUT_CHANNEL,
             nvl(actual.store_type,TARGET.STORE_TYPE) as store_type,
             NULL AS PRIORITIZATION_SEGMENTATION,
             NULL AS STORE_CATEGORY,
             COALESCE(actual.store_code,TARGET.STORE_CODE,'NA') AS STORE_CODE,
             COALESCE(actual.store_name,TARGET.STORE_NAME,'NA') as STORE_NAME,
             COALESCE(TARGET.STORE_GRADE, 'NA') AS STORE_GRADE,
             'NA' as STORE_SIZE,
             nvl(actual.REGION,TARGET.REGION) as REGION,
             nvl(actual.ZONE_OR_AREA,TARGET.zone_or_area) as ZONE_NAME,
             'NA' as CITY,
             NULL AS RTRLATITUDE,
             NULL AS RTRLONGITUDE,
             nvl(actual.RETAIL_ENVIRONMENT,TARGET.retail_environment) AS Sell_Out_RE,
             nvl(actual.EAN,TARGET.EAN) AS PRODUCT_CODE,
             COALESCE(actual.msl_product_desc, target.msl_product_desc,'NA') AS PRODUCT_NAME,
             TARGET.PROD_HIER_L1 AS PROD_HIER_L1,
             TARGET.PROD_HIER_L2 AS PROD_HIER_L2,
             TARGET.PROD_HIER_L3 AS PROD_HIER_L3,
             target.PROD_HIER_L4 AS  PROD_HIER_L4,
             TARGET.PROD_HIER_L5 AS PROD_HIER_L5,
             TARGET.PROD_HIER_L6 AS PROD_HIER_L6,
             TARGET.PROD_HIER_L7 AS PROD_HIER_L7,
             TARGET.PROD_HIER_L8 AS PROD_HIER_L8,
			 --NULL AS PROD_HIER_L9,
             TARGET.PROD_HIER_L9 AS PROD_HIER_L9,
             COALESCE(actual.sku_code, target.sku_code) AS MAPPED_SKU_CD,
			 actual.list_price,
             --'POS' as data_src,
             COALESCE(ACTUAL.DATA_SRC, TARGET.DATA_SRC) AS DATA_SRC,
             COALESCE(ACTUAL.CUSTOMER_SEGMENT_KEY,CUSTOMER.CUST_SEGMT_KEY,'NA') AS CUSTOMER_SEGMENT_KEY,
             COALESCE(ACTUAL.CUSTOMER_SEGMENT_DESCRIPTION,CUSTOMER.CUST_SEGMENT_DESC,'NA') AS CUSTOMER_SEGMENT_DESCRIPTION,
             COALESCE(ACTUAL.RETAIL_ENVIRONMENT,target.retail_environment,'NA') AS RETAIL_ENVIRONMENT,
             COALESCE(ACTUAL.SAP_CUSTOMER_CHANNEL_KEY,CUSTOMER.SAP_CUST_CHNL_KEY,'NA') AS SAP_CUSTOMER_CHANNEL_KEY,
             COALESCE(ACTUAL.SAP_CUSTOMER_CHANNEL_DESCRIPTION,CUSTOMER.SAP_CUST_CHNL_DESC,'NA') AS SAP_CUSTOMER_CHANNEL_DESCRIPTION,
             COALESCE(ACTUAL.SAP_CUSTOMER_SUB_CHANNEL_KEY,CUSTOMER.SAP_CUST_SUB_CHNL_KEY,'NA') AS SAP_CUSTOMER_SUB_CHANNEL_KEY,
             COALESCE(ACTUAL.SAP_SUB_CHANNEL_DESCRIPTION,CUSTOMER.SAP_SUB_CHNL_DESC,'NA') AS SAP_SUB_CHANNEL_DESCRIPTION,
             COALESCE(ACTUAL.SAP_PARENT_CUSTOMER_KEY,CUSTOMER.SAP_PRNT_CUST_KEY,'NA') AS SAP_PARENT_CUSTOMER_KEY,
             COALESCE(ACTUAL.SAP_PARENT_CUSTOMER_DESCRIPTION,CUSTOMER.SAP_PRNT_CUST_DESC,'NA') AS SAP_PARENT_CUSTOMER_DESCRIPTION,
             COALESCE(ACTUAL.SAP_BANNER_KEY,CUSTOMER.SAP_BNR_KEY,'NA') AS SAP_BANNER_KEY,
             COALESCE(ACTUAL.SAP_BANNER_DESCRIPTION,CUSTOMER.SAP_BNR_DESC,'NA') AS SAP_BANNER_DESCRIPTION,
             COALESCE(ACTUAL.SAP_BANNER_FORMAT_KEY,CUSTOMER.SAP_BNR_FRMT_KEY,'NA') AS SAP_BANNER_FORMAT_KEY,
             COALESCE(ACTUAL.SAP_BANNER_FORMAT_DESCRIPTION,CUSTOMER.SAP_BNR_FRMT_DESC,'NA') AS SAP_BANNER_FORMAT_DESCRIPTION,
             --REGION,
             --ZONE_OR_AREA,
             TRIM(NVL (NULLIF(CUSTOMER.SAP_CUST_NM,''),'NA')) AS CUSTOMER_NAME,
             TRIM(NVL (NULLIF(CUSTOMER.SAP_CUST_ID,''),'NA')) AS CUSTOMER_CODE,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_SGMT_CD,''),'NA')) AS SAP_PROD_SGMT_CD,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_SGMT_DESC,''),'NA')) AS SAP_PROD_SGMT_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_BASE_PROD_DESC,''),'NA')) AS SAP_BASE_PROD_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_MEGA_BRND_DESC,''),'NA')) AS SAP_MEGA_BRND_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_BRND_DESC,''),'NA')) AS SAP_BRND_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_VRNT_DESC,''),'NA')) AS SAP_VRNT_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PUT_UP_DESC,''),'NA')) AS SAP_PUT_UP_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_GRP_FRNCHSE_CD,''),'NA')) AS SAP_GRP_FRNCHSE_CD,
             TRIM(NVL (NULLIF(PRODUCT.SAP_GRP_FRNCHSE_DESC,''),'NA')) AS SAP_GRP_FRNCHSE_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_FRNCHSE_CD,''),'NA')) AS SAP_FRNCHSE_CD,
             TRIM(NVL (NULLIF(PRODUCT.SAP_FRNCHSE_DESC,''),'NA')) AS SAP_FRNCHSE_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_FRNCHSE_CD,''),'NA')) AS SAP_PROD_FRNCHSE_CD,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_FRNCHSE_DESC,''),'NA')) AS SAP_PROD_FRNCHSE_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_MJR_CD,''),'NA')) AS SAP_PROD_MJR_CD,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_MJR_DESC,''),'NA')) AS SAP_PROD_MJR_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_MNR_CD,''),'NA')) AS SAP_PROD_MNR_CD,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_MNR_DESC,''),'NA')) AS SAP_PROD_MNR_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_HIER_CD,''),'NA')) AS SAP_PROD_HIER_CD,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_HIER_DESC,''),'NA')) AS SAP_PROD_HIER_DESC,
             COALESCE(ACTUAL.GLOBAL_PRODUCT_FRANCHISE,PRODUCT.GPH_PROD_FRNCHSE) AS GLOBAL_PRODUCT_FRANCHISE,
             COALESCE(ACTUAL.GLOBAL_PRODUCT_BRAND,PRODUCT.GPH_PROD_BRND) AS GLOBAL_PRODUCT_BRAND,
             COALESCE(ACTUAL.GLOBAL_PRODUCT_SUB_BRAND,PRODUCT.GPH_PROD_SUB_BRND) AS GLOBAL_PRODUCT_SUB_BRAND,
             COALESCE(ACTUAL.GLOBAL_PRODUCT_VARIANT,PRODUCT.GPH_PROD_VRNT) AS GLOBAL_PRODUCT_VARIANT,
             COALESCE(ACTUAL.GLOBAL_PRODUCT_SEGMENT,PRODUCT.GPH_PROD_NEEDSTATE) AS GLOBAL_PRODUCT_SEGMENT,
             COALESCE(ACTUAL.GLOBAL_PRODUCT_SUBSEGMENT,PRODUCT.GPH_PROD_SUBSGMNT) AS GLOBAL_PRODUCT_SUBSEGMENT,
             COALESCE(ACTUAL.GLOBAL_PRODUCT_CATEGORY,PRODUCT.GPH_PROD_CTGRY) AS GLOBAL_PRODUCT_CATEGORY,
             COALESCE(ACTUAL.GLOBAL_PRODUCT_SUBCATEGORY,PRODUCT.GPH_PROD_SUBCTGRY) AS GLOBAL_PRODUCT_SUBCATEGORY,
             COALESCE(ACTUAL.GLOBAL_PUT_UP_DESCRIPTION,PRODUCT.GPH_PROD_PUT_UP_DESC) AS GLOBAL_PUT_UP_DESCRIPTION,
             --TRIM(NVL (NULLIF(PRODUCT.EAN,''),'NA')) AS EAN,
             --TRIM(NVL (NULLIF(PRODUCT.SAP_MATL_NUM,''),'NA'))AS SKU_CODE,
             TRIM(NVL (NULLIF(PRODUCT.SAP_MAT_DESC,''),'NA'))AS SKU_DESCRIPTION,
             TRIM(NVL (NULLIF(PRODUCT.PKA_FRANCHISE_DESC,''),'NA')) AS PKA_FRANCHISE_DESC,
             TRIM(NVL (NULLIF(PRODUCT.PKA_BRAND_DESC,''),'NA')) AS PKA_BRAND_DESC,
             TRIM(NVL (NULLIF(PRODUCT.PKA_SUB_BRAND_DESC,''),'NA')) AS PKA_SUB_BRAND_DESC,
             TRIM(NVL (NULLIF(PRODUCT.PKA_VARIANT_DESC,''),'NA')) AS PKA_VARIANT_DESC,
             TRIM(NVL (NULLIF(PRODUCT.PKA_SUB_VARIANT_DESC,''),'NA')) AS PKA_SUB_VARIANT_DESC,
             COALESCE(ACTUAL.PKA_PRODUCT_KEY,PRODUCT.PKA_PRODUCT_KEY) AS PKA_PRODUCT_KEY,
             COALESCE(ACTUAL.PKA_PRODUCT_KEY_DESCRIPTION,PRODUCT.PKA_PRODUCT_KEY_DESCRIPTION) AS PKA_PRODUCT_KEY_DESCRIPTION,
             ACTUAL.CM_SALES AS SALES_VALUE,
             ACTUAL.CM_SALES_QTY AS SALES_QTY,
             ACTUAL.CM_AVG_SALES_QTY AS AVG_SALES_QTY,
             ACTUAL.SALES_VALUE_LIST_PRICE AS SALES_VALUE_LIST_PRICE,
             ACTUAL.LM_SALES AS LM_SALES,
             ACTUAL.LM_SALES_QTY AS LM_SALES_QTY,
             ACTUAL.LM_AVG_SALES_QTY AS LM_AVG_SALES_QTY,
             ACTUAL.LM_SALES_LP AS LM_SALES_LP,
             ACTUAL.P3M_SALES AS P3M_SALES,
             ACTUAL.P3M_QTY AS P3M_QTY,
             ACTUAL.P3M_AVG_QTY AS P3M_AVG_QTY,
             ACTUAL.P3M_SALES_LP AS P3M_SALES_LP,
             ACTUAL.F3M_SALES AS F3M_SALES,
             ACTUAL.F3M_QTY AS F3M_QTY,
             ACTUAL.F3M_AVG_QTY AS F3M_AVG_QTY,
             ACTUAL.P6M_SALES AS P6M_SALES,
             ACTUAL.P6M_QTY AS P6M_QTY,
             ACTUAL.P6M_AVG_QTY AS P6M_AVG_QTY,
             ACTUAL.P6M_SALES_LP AS P6M_SALES_LP,
             ACTUAL.P12M_SALES AS P12M_SALES,
             ACTUAL.P12M_QTY AS P12M_QTY,
             ACTUAL.P12M_AVG_QTY AS P12M_AVG_QTY,
             ACTUAL.P12M_SALES_LP AS P12M_SALES_LP,
             COALESCE(ACTUAL.LM_SALES_FLAG,'N') AS LM_SALES_FLAG,
             COALESCE(ACTUAL.P3M_SALES_FLAG,'N') AS P3M_SALES_FLAG,
             COALESCE(ACTUAL.P6M_SALES_FLAG,'N') AS P6M_SALES_FLAG,
             COALESCE(ACTUAL.P12M_SALES_FLAG,'N') AS P12M_SALES_FLAG,
             'Y' AS MDP_FLAG,
             1 AS TARGET_COMPLAINCE
      FROM wks_tw_re_msl_list TARGET
        LEFT JOIN (SELECT * FROM WKS_TW_RE_ACTUALS) ACTUAL
               ON TARGET.jj_mnth_id = ACTUAL.MNTH_ID
              --AND TARGET.DISTRIBUTOR_NAME = ACTUAL.DISTRIBUTOR_NAME
              AND UPPER(LTRIM(TARGET.DISTRIBUTOR_CODE,'0')) = UPPER(LTRIM(ACTUAL.DISTRIBUTOR_CODE,'0'))
              AND ltrim(TARGET.STORE_CODE,0) = ltrim(ACTUAL.STORE_CODE,0)
              AND UPPER (TRIM (TARGET.EAN)) = UPPER (TRIM (ACTUAL.EAN))
			  and UPPER (target.retail_environment) = UPPER (actual.retail_environment) 
              and UPPER (target.Sell_Out_Channel) = UPPER (actual.CHANNEL_NAME) 
			  and UPPER(target.market) = UPPER(actual.CNTRY_NM)
     
      ----------------customer hierarchy------------------------------          
      
        LEFT JOIN (SELECT *
                   FROM customer_heirarchy 
				   WHERE RANK = 1) CUSTOMER ON  nvl(ltrim(ACTUAL.SOLDTO_CODE,0), ltrim(TARGET.SOLDTO_CODE,0)) = LTRIM (CUSTOMER.SAP_CUST_ID,'0')
      ----------------product hierarchy------------------------------   				   
      
        LEFT JOIN product_heirarchy PRODUCT
			   ON LTRIM(COALESCE(ACTUAL.SKU_CODE,TARGET.SKU_CODE),'0') = LTRIM(PRODUCT.sap_matl_num,'0')
              AND product.rank = 1
	) Q
  JOIN (SELECT DISTINCT "cluster"
        FROM EDW_COMPANY_DIM
        WHERE CTRY_GROUP in ('Taiwan')) COM 
WHERE jj_mnth_id::NUMERIC<= (SELECT MAX(mnth_id)::NUMERIC FROM WKS_TW_RE_ACTUALS)
),

------------Non mdp--------------------------------
TW_RPT_RE_non_mdp  as (
SELECT distinct Q.*,
       COM.*
FROM (SELECT LEFT(ACTUAL.MNTH_ID,4)::numeric(18,0) AS YEAR,
             ACTUAL.MNTH_ID::numeric(18,0) AS MNTH_ID,			 			
             ACTUAL.CNTRY_NM AS MARKET,
             nvl(actual.channel_name,'NA') AS CHANNEL,
             ACTUAL.soldto_code,
             ACTUAL.DISTRIBUTOR_CODE,
             ACTUAL.DISTRIBUTOR_NAME,
             nvl(actual.channel_name,'NA') AS SELL_OUT_CHANNEL,
             COALESCE(actual.STORE_TYPE, 'NA') AS STORE_TYPE,
             NULL AS PRIORITIZATION_SEGMENTATION,
             NULL AS STORE_CATEGORY,
             COALESCE(ACTUAL.STORE_CODE,'NA') AS STORE_CODE,
             COALESCE(ACTUAL.STORE_NAME,'NA') AS STORE_NAME,
             NULL AS STORE_GRADE,
             NULL AS STORE_SIZE,
             actual.region,
             actual.zone_or_area AS ZONE_NAME,
             'NA' as CITY,
             NULL AS RTRLATITUDE,
             NULL AS RTRLONGITUDE,
             ACTUAL.retail_environment AS sell_out_RE,
             ACTUAL.EAN AS PRODUCT_CODE,
             COALESCE(actual.msl_product_desc,'NA') AS PRODUCT_NAME,
             epd.prod_hier_l1  AS prod_hier_l1,
             epd.prod_hier_l2 AS prod_hier_l2,
             epd.prod_hier_l3 AS prod_hier_l3,
             epd.prod_hier_l4 AS prod_hier_l4,
             epd.prod_hier_l5 as prod_hier_l5,
             -- varient is sku_name from msl table NA_ITG.itg_mcs_gt
             epd.prod_hier_l6 AS prod_hier_l6,
             epd.prod_hier_l7 AS prod_hier_l7,
             epd.prod_hier_l8 AS prod_hier_l8,
			 --NULL as  prod_hier_l9,
             epd.prod_hier_l9 as  prod_hier_l9,
             actual.sku_code AS MAPPED_SKU_CD,
			 actual.list_price,
             --actual.data_src,
             ACTUAL.DATA_SRC AS DATA_SRC,
             COALESCE(ACTUAL.CUSTOMER_SEGMENT_KEY,CUSTOMER.CUST_SEGMT_KEY) AS CUSTOMER_SEGMENT_KEY,
             COALESCE(ACTUAL.CUSTOMER_SEGMENT_DESCRIPTION,CUSTOMER.CUST_SEGMENT_DESC) AS CUSTOMER_SEGMENT_DESCRIPTION,
             COALESCE(ACTUAL.RETAIL_ENVIRONMENT,'NA') AS RETAIL_ENVIRONMENT,
             COALESCE(ACTUAL.SAP_CUSTOMER_CHANNEL_KEY,CUSTOMER.SAP_CUST_CHNL_KEY) AS SAP_CUSTOMER_CHANNEL_KEY,
             COALESCE(ACTUAL.SAP_CUSTOMER_CHANNEL_DESCRIPTION,CUSTOMER.SAP_CUST_CHNL_DESC) AS SAP_CUSTOMER_CHANNEL_DESCRIPTION,
             COALESCE(ACTUAL.SAP_CUSTOMER_SUB_CHANNEL_KEY,CUSTOMER.SAP_CUST_SUB_CHNL_KEY) AS SAP_CUSTOMER_SUB_CHANNEL_KEY,
             COALESCE(ACTUAL.SAP_SUB_CHANNEL_DESCRIPTION,CUSTOMER.SAP_SUB_CHNL_DESC) AS SAP_SUB_CHANNEL_DESCRIPTION,
             COALESCE(ACTUAL.SAP_PARENT_CUSTOMER_KEY,CUSTOMER.SAP_PRNT_CUST_KEY) AS SAP_PARENT_CUSTOMER_KEY,
             COALESCE(ACTUAL.SAP_PARENT_CUSTOMER_DESCRIPTION,CUSTOMER.SAP_PRNT_CUST_DESC) AS SAP_PARENT_CUSTOMER_DESCRIPTION,
             COALESCE(ACTUAL.SAP_BANNER_KEY,CUSTOMER.SAP_BNR_KEY) AS SAP_BANNER_KEY,
             COALESCE(ACTUAL.SAP_BANNER_DESCRIPTION,CUSTOMER.SAP_BNR_DESC) AS SAP_BANNER_DESCRIPTION,
             COALESCE(ACTUAL.SAP_BANNER_FORMAT_KEY,CUSTOMER.SAP_BNR_FRMT_KEY) AS SAP_BANNER_FORMAT_KEY,
             COALESCE(ACTUAL.SAP_BANNER_FORMAT_DESCRIPTION,CUSTOMER.SAP_BNR_FRMT_DESC) AS SAP_BANNER_FORMAT_DESCRIPTION,
             --REGION,
             --ZONE_OR_AREA,
             TRIM(NVL (NULLIF(CUSTOMER.SAP_CUST_NM,''),'NA')) AS CUSTOMER_NAME,
             TRIM(NVL (NULLIF(CUSTOMER.SAP_CUST_ID,''),'NA')) AS CUSTOMER_CODE,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_SGMT_CD,''),'NA')) AS SAP_PROD_SGMT_CD,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_SGMT_DESC,''),'NA')) AS SAP_PROD_SGMT_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_BASE_PROD_DESC,''),'NA')) AS SAP_BASE_PROD_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_MEGA_BRND_DESC,''),'NA')) AS SAP_MEGA_BRND_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_BRND_DESC,''),'NA')) AS SAP_BRND_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_VRNT_DESC,''),'NA')) AS SAP_VRNT_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PUT_UP_DESC,''),'NA')) AS SAP_PUT_UP_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_GRP_FRNCHSE_CD,''),'NA')) AS SAP_GRP_FRNCHSE_CD,
             TRIM(NVL (NULLIF(PRODUCT.SAP_GRP_FRNCHSE_DESC,''),'NA')) AS SAP_GRP_FRNCHSE_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_FRNCHSE_CD,''),'NA')) AS SAP_FRNCHSE_CD,
             TRIM(NVL (NULLIF(PRODUCT.SAP_FRNCHSE_DESC,''),'NA')) AS SAP_FRNCHSE_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_FRNCHSE_CD,''),'NA')) AS SAP_PROD_FRNCHSE_CD,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_FRNCHSE_DESC,''),'NA')) AS SAP_PROD_FRNCHSE_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_MJR_CD,''),'NA')) AS SAP_PROD_MJR_CD,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_MJR_DESC,''),'NA')) AS SAP_PROD_MJR_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_MNR_CD,''),'NA')) AS SAP_PROD_MNR_CD,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_MNR_DESC,''),'NA')) AS SAP_PROD_MNR_DESC,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_HIER_CD,''),'NA')) AS SAP_PROD_HIER_CD,
             TRIM(NVL (NULLIF(PRODUCT.SAP_PROD_HIER_DESC,''),'NA')) AS SAP_PROD_HIER_DESC,
             COALESCE(ACTUAL.GLOBAL_PRODUCT_FRANCHISE,PRODUCT.GPH_PROD_FRNCHSE) AS GLOBAL_PRODUCT_FRANCHISE,
             COALESCE(ACTUAL.GLOBAL_PRODUCT_BRAND,PRODUCT.GPH_PROD_BRND) AS GLOBAL_PRODUCT_BRAND,
             COALESCE(ACTUAL.GLOBAL_PRODUCT_SUB_BRAND,PRODUCT.GPH_PROD_SUB_BRND) AS GLOBAL_PRODUCT_SUB_BRAND,
             COALESCE(ACTUAL.GLOBAL_PRODUCT_VARIANT,PRODUCT.GPH_PROD_VRNT) AS GLOBAL_PRODUCT_VARIANT,
             COALESCE(ACTUAL.GLOBAL_PRODUCT_SEGMENT,PRODUCT.GPH_PROD_NEEDSTATE) AS GLOBAL_PRODUCT_SEGMENT,
             COALESCE(ACTUAL.GLOBAL_PRODUCT_SUBSEGMENT,PRODUCT.GPH_PROD_SUBSGMNT) AS GLOBAL_PRODUCT_SUBSEGMENT,
             COALESCE(ACTUAL.GLOBAL_PRODUCT_CATEGORY,PRODUCT.GPH_PROD_CTGRY) AS GLOBAL_PRODUCT_CATEGORY,
             COALESCE(ACTUAL.GLOBAL_PRODUCT_SUBCATEGORY,PRODUCT.GPH_PROD_SUBCTGRY) AS GLOBAL_PRODUCT_SUBCATEGORY,
             COALESCE(ACTUAL.GLOBAL_PUT_UP_DESCRIPTION,PRODUCT.GPH_PROD_PUT_UP_DESC) AS GLOBAL_PUT_UP_DESCRIPTION,
             --TRIM(NVL (NULLIF(PRODUCT.EAN,''),'NA')) AS EAN,
             --TRIM(NVL (NULLIF(PRODUCT.SAP_MATL_NUM,''),'NA'))AS SKU_CODE,
             TRIM(NVL (NULLIF(PRODUCT.SAP_MAT_DESC,''),'NA'))AS SKU_DESCRIPTION,
             TRIM(NVL (NULLIF(PRODUCT.PKA_FRANCHISE_DESC,''),'NA')) AS PKA_FRANCHISE_DESC,
             TRIM(NVL (NULLIF(PRODUCT.PKA_BRAND_DESC,''),'NA')) AS PKA_BRAND_DESC,
             TRIM(NVL (NULLIF(PRODUCT.PKA_SUB_BRAND_DESC,''),'NA')) AS PKA_SUB_BRAND_DESC,
             TRIM(NVL (NULLIF(PRODUCT.PKA_VARIANT_DESC,''),'NA')) AS PKA_VARIANT_DESC,
             TRIM(NVL (NULLIF(PRODUCT.PKA_SUB_VARIANT_DESC,''),'NA')) AS PKA_SUB_VARIANT_DESC,
             COALESCE(ACTUAL.PKA_PRODUCT_KEY,PRODUCT.PKA_PRODUCT_KEY) AS PKA_PRODUCT_KEY,
             COALESCE(ACTUAL.PKA_PRODUCT_KEY_DESCRIPTION,PRODUCT.PKA_PRODUCT_KEY_DESCRIPTION) AS PKA_PRODUCT_KEY_DESCRIPTION,
             ACTUAL.CM_SALES AS SALES_VALUE,
             ACTUAL.CM_SALES_QTY AS SALES_QTY,
             ACTUAL.CM_AVG_SALES_QTY AS AVG_SALES_QTY,
             ACTUAL.SALES_VALUE_LIST_PRICE AS SALES_VALUE_LIST_PRICE,
             ACTUAL.LM_SALES AS LM_SALES,
             ACTUAL.LM_SALES_QTY AS LM_SALES_QTY,
             ACTUAL.LM_AVG_SALES_QTY AS LM_AVG_SALES_QTY,
             ACTUAL.LM_SALES_LP AS LM_SALES_LP,
             ACTUAL.P3M_SALES AS P3M_SALES,
             ACTUAL.P3M_QTY AS P3M_QTY,
             ACTUAL.P3M_AVG_QTY AS P3M_AVG_QTY,
             ACTUAL.P3M_SALES_LP AS P3M_SALES_LP,
             ACTUAL.F3M_SALES AS F3M_SALES,
             ACTUAL.F3M_QTY AS F3M_QTY,
             ACTUAL.F3M_AVG_QTY AS F3M_AVG_QTY,
             ACTUAL.P6M_SALES AS P6M_SALES,
             ACTUAL.P6M_QTY AS P6M_QTY,
             ACTUAL.P6M_AVG_QTY AS P6M_AVG_QTY,
             ACTUAL.P6M_SALES_LP AS P6M_SALES_LP,
             ACTUAL.P12M_SALES AS P12M_SALES,
             ACTUAL.P12M_QTY AS P12M_QTY,
             ACTUAL.P12M_AVG_QTY AS P12M_AVG_QTY,
             ACTUAL.P12M_SALES_LP AS P12M_SALES_LP,
             ACTUAL.LM_SALES_FLAG,
             ACTUAL.P3M_SALES_FLAG,
             ACTUAL.P6M_SALES_FLAG,
             ACTUAL.P12M_SALES_FLAG,
             'N' AS MDP_FLAG,
             1 AS TARGET_COMPLAINCE
      FROM (SELECT * FROM WKS_TW_RE_ACTUALS A
            WHERE NOT EXISTS (SELECT 1
                              FROM wks_tw_re_msl_list T
                              WHERE T.jj_mnth_id = A.MNTH_ID
              --AND T.DISTRIBUTOR_NAME = A.DISTRIBUTOR_NAME
              AND UPPER(LTRIM(T.DISTRIBUTOR_CODE,'0')) = UPPER(LTRIM(A.DISTRIBUTOR_CODE,'0'))
              AND ltrim(T.STORE_CODE,0) = ltrim(A.STORE_CODE,0)
              AND UPPER (TRIM (T.EAN)) = UPPER (TRIM (A.EAN))
              and UPPER (T.retail_environment) = UPPER (A.retail_environment) 
              and UPPER (T.Sell_Out_Channel) = UPPER (A.CHANNEL_NAME) 
			  and UPPER(T.market) = UPPER(A.CNTRY_NM)
			)) ACTUAL
        left join (SELECT DISTINCT prd.country_l1 AS prod_hier_l1,
            prd.regional_franchise_l2 AS prod_hier_l2,
            prd.franchise_l3 AS prod_hier_l3,
            prd.brand_l4 AS prod_hier_l4,
            prd.sub_category_l5 AS prod_hier_l5,
            prd.platform_l6 AS prod_hier_l6,
            prd.variance_l7 AS prod_hier_l7,
            prd.pack_size_l8 AS prod_hier_l8,
            NULL AS prod_hier_l9,
            prd.barcode
        FROM edw_vw_pop6_products prd
        WHERE cntry_cd = 'TW') epd
        ON UPPER (TRIM (actual.ean)) = UPPER (TRIM (epd.barcode))

      ----------------customer hierarchy------------------------------          
      
        LEFT JOIN (SELECT *
                   FROM customer_heirarchy
                   WHERE RANK = 1) CUSTOMER ON LTRIM (ACTUAL.soldto_code,'0') = LTRIM (CUSTOMER.SAP_CUST_ID,'0')
      ----------------product hierarchy------------------------------   				   
      
        LEFT JOIN product_heirarchy PRODUCT
               ON LTRIM (actual.sku_code,'0') = LTRIM (PRODUCT.SAP_MATL_NUM,'0')
              AND product.rank = 1) Q
			  JOIN (SELECT DISTINCT "cluster"
        FROM EDW_COMPANY_DIM
        WHERE CTRY_GROUP in ('Taiwan')) COM 

)

select * from TW_RPT_RE_mdp
union 
select * from TW_RPT_RE_non_mdp
);

------------------------------------

delete from PROD_DNA_CORE.DBT_CLOUD_PR_5458_1220.NTAWKS_INTEGRATION__WKS_TW_RPT_RE_GCPH;

insert into PROD_DNA_CORE.DBT_CLOUD_PR_5458_1220.NTAWKS_INTEGRATION__WKS_TW_RPT_RE_GCPH (

with wks_tw_rpt_re as (
    select * from PROD_DNA_CORE.DBT_CLOUD_PR_5458_1220.NTAWKS_INTEGRATION__WKS_TW_RPT_RE
)

SELECT jj_year::numeric(18,0) as jj_year,
       jj_mnth_id::numeric(18,0) as jj_mnth_id,
       "cluster",
       MARKET,
       data_src,
       CHANNEL_NAME,
       soldto_code,
       DISTRIBUTOR_CODE,
       DISTRIBUTOR_NAME,
       SELL_OUT_CHANNEL,
       STORE_TYPE,
       PRIORITIZATION_SEGMENTATION,
       STORE_CATEGORY,
       STORE_CODE,
       STORE_NAME,
       STORE_GRADE,
       STORE_SIZE,
       REGION,
       ZONE_NAME,
       CITY,
       RTRLATITUDE,
       RTRLONGITUDE,
       CUSTOMER_SEGMENT_KEY,
       CUSTOMER_SEGMENT_DESCRIPTION,
       RETAIL_ENVIRONMENT,
       SAP_CUSTOMER_CHANNEL_KEY,
       SAP_CUSTOMER_CHANNEL_DESCRIPTION,
       SAP_CUSTOMER_SUB_CHANNEL_KEY,
       SAP_SUB_CHANNEL_DESCRIPTION,
       SAP_PARENT_CUSTOMER_KEY,
       SAP_PARENT_CUSTOMER_DESCRIPTION,
       SAP_BANNER_KEY,
       SAP_BANNER_DESCRIPTION,
       SAP_BANNER_FORMAT_KEY,
       SAP_BANNER_FORMAT_DESCRIPTION,
       CUSTOMER_NAME,
       LTRIM(CUSTOMER_CODE,'0') AS CUSTOMER_CODE,
       PRODUCT_CODE,
       PRODUCT_NAME,
       PROD_HIER_L1,
       PROD_HIER_L2,
       PROD_HIER_L3,
       PROD_HIER_L4,
       PROD_HIER_L5,
       PROD_HIER_L6,
       PROD_HIER_L7,
       PROD_HIER_L8,
       PROD_HIER_L9,
       MAPPED_SKU_CD,
       SAP_PROD_SGMT_CD,
       SAP_PROD_SGMT_DESC,
       --SAP_BASE_PROD_CD,
       SAP_BASE_PROD_DESC,
       --SAP_MEGA_BRND_CD,
       SAP_MEGA_BRND_DESC,
       --SAP_BRND_CD,
       SAP_BRND_DESC,
       --SAP_VRNT_CD,
       SAP_VRNT_DESC,
       --SAP_PUT_UP_CD,
       SAP_PUT_UP_DESC,
       SAP_GRP_FRNCHSE_CD,
       SAP_GRP_FRNCHSE_DESC,
       SAP_FRNCHSE_CD,
       SAP_FRNCHSE_DESC,
       SAP_PROD_FRNCHSE_CD,
       SAP_PROD_FRNCHSE_DESC,
       SAP_PROD_MJR_CD,
       SAP_PROD_MJR_DESC,
       SAP_PROD_MNR_CD,
       SAP_PROD_MNR_DESC,
       SAP_PROD_HIER_CD,
       SAP_PROD_HIER_DESC,
       --PKA_FRANCHISE_CD,
       PKA_FRANCHISE_DESC,
       --PKA_BRAND_CD,
       PKA_BRAND_DESC,
       --PKA_SUB_BRAND_CD,
       PKA_SUB_BRAND_DESC,
       --PKA_VARIANT_CD,
       PKA_VARIANT_DESC,
       --PKA_SUB_VARIANT_CD,
       PKA_SUB_VARIANT_DESC,
       GLOBAL_PRODUCT_FRANCHISE,
       GLOBAL_PRODUCT_BRAND,
       GLOBAL_PRODUCT_SUB_BRAND,
       GLOBAL_PRODUCT_VARIANT,
       GLOBAL_PRODUCT_SEGMENT,
       GLOBAL_PRODUCT_SUBSEGMENT,
       GLOBAL_PRODUCT_CATEGORY,
       GLOBAL_PRODUCT_SUBCATEGORY,
       GLOBAL_PUT_UP_DESCRIPTION,
       --EAN,
       --SKU_CODE,
       SKU_DESCRIPTION,
       --GREENLIGHT_SKU_FLAG,
       CASE
         WHEN PKA_PRODUCT_KEY IN ('N/A','NA') THEN 'NA'
         ELSE PKA_PRODUCT_KEY
       END AS PKA_PRODUCT_KEY,
       CASE
         WHEN PKA_PRODUCT_KEY_DESCRIPTION IN ('N/A','NA') THEN 'NA'
         ELSE PKA_PRODUCT_KEY_DESCRIPTION
       END AS PKA_PRODUCT_KEY_DESCRIPTION,
       SALES_VALUE,
       SALES_QTY,
       AVG_SALES_QTY,
       SALES_VALUE_LIST_PRICE,
       LM_SALES,
       LM_SALES_QTY,
       LM_AVG_SALES_QTY,
       LM_SALES_LP,
       P3M_SALES,
       P3M_QTY,
       P3M_AVG_QTY,
       P3M_SALES_LP,
       P6M_SALES,
       P6M_QTY,
       P6M_AVG_QTY,
       P6M_SALES_LP,
       P12M_SALES,
       P12M_QTY,
       P12M_AVG_QTY,
       P12M_SALES_LP,
       F3M_SALES,
       F3M_QTY,
       F3M_AVG_QTY,
       LM_SALES_FLAG,
       P3M_SALES_FLAG,
       P6M_SALES_FLAG,
       P12M_SALES_FLAG,
       MDP_FLAG,
       TARGET_COMPLAINCE:: numeric(18,0) as TARGET_COMPLAINCE,
       LIST_PRICE,
       TOTAL_SALES_LM,
       TOTAL_SALES_P3M,
       TOTAL_SALES_P6M,
       TOTAL_SALES_P12M,
       TOTAL_SALES_BY_STORE_LM,
       TOTAL_SALES_BY_STORE_P3M,
       TOTAL_SALES_BY_STORE_P6M,
       TOTAL_SALES_BY_STORE_P12M,
       TOTAL_SALES_BY_SKU_LM,
       TOTAL_SALES_BY_SKU_P3M,
       TOTAL_SALES_BY_SKU_P6M,
       TOTAL_SALES_BY_SKU_P12M,
	   TOTAL_SALES_LM_LP,
       TOTAL_SALES_P3M_LP,
       TOTAL_SALES_P6M_LP,
       TOTAL_SALES_P12M_LP,
       TOTAL_SALES_BY_STORE_LM_LP,
       TOTAL_SALES_BY_STORE_P3M_LP,
       TOTAL_SALES_BY_STORE_P6M_LP,
       TOTAL_SALES_BY_STORE_P12M_LP,
       TOTAL_SALES_BY_SKU_LM_LP,
       TOTAL_SALES_BY_SKU_P3M_LP,
       TOTAL_SALES_BY_SKU_P6M_LP,
       TOTAL_SALES_BY_SKU_P12M_LP,
       (TOTAL_SALES_BY_STORE_LM / NULLIF(TOTAL_SALES_LM,0)) AS STORE_CONTRIBUTION_LM,
       (TOTAL_SALES_BY_SKU_LM / NULLIF(TOTAL_SALES_LM,0)) AS SKU_CONTRIBUTION_LM,
       (STORE_CONTRIBUTION_LM*SKU_CONTRIBUTION_LM*TOTAL_SALES_LM) AS SIZE_OF_PRICE_LM,
       (TOTAL_SALES_BY_STORE_P3M / NULLIF(TOTAL_SALES_P3M,0)) AS STORE_CONTRIBUTION_P3M,
       (TOTAL_SALES_BY_SKU_P3M / NULLIF(TOTAL_SALES_P3M,0)) AS SKU_CONTRIBUTION_P3M,
       (STORE_CONTRIBUTION_P3M*SKU_CONTRIBUTION_P3M*TOTAL_SALES_P3M) AS SIZE_OF_PRICE_P3M,
       (TOTAL_SALES_BY_STORE_P6M / NULLIF(TOTAL_SALES_P6M,0)) AS STORE_CONTRIBUTION_P6M,
       (TOTAL_SALES_BY_SKU_P6M / NULLIF(TOTAL_SALES_P6M,0)) AS SKU_CONTRIBUTION_P6M,
       (STORE_CONTRIBUTION_P6M*SKU_CONTRIBUTION_P6M*TOTAL_SALES_P6M) AS SIZE_OF_PRICE_P6M,
       (TOTAL_SALES_BY_STORE_P12M / NULLIF(TOTAL_SALES_P12M,0)) AS STORE_CONTRIBUTION_P12M,
       (TOTAL_SALES_BY_SKU_P12M / NULLIF(TOTAL_SALES_P12M,0)) AS SKU_CONTRIBUTION_P12M,
       (STORE_CONTRIBUTION_P12M*SKU_CONTRIBUTION_P12M*TOTAL_SALES_P12M) AS SIZE_OF_PRICE_P12M,
       (TOTAL_SALES_BY_STORE_LM_LP / NULLIF(TOTAL_SALES_LM_LP,0)) AS STORE_CONTRIBUTION_LM_LP,
       (TOTAL_SALES_BY_SKU_LM_LP / NULLIF(TOTAL_SALES_LM_LP,0)) AS SKU_CONTRIBUTION_LM_LP,
       (STORE_CONTRIBUTION_LM_LP*SKU_CONTRIBUTION_LM_LP*TOTAL_SALES_LM_LP) AS SIZE_OF_PRICE_LM_LP,
       (TOTAL_SALES_BY_STORE_P3M_LP / NULLIF(TOTAL_SALES_P3M_LP,0)) AS STORE_CONTRIBUTION_P3M_LP,
       (TOTAL_SALES_BY_SKU_P3M_LP / NULLIF(TOTAL_SALES_P3M_LP,0)) AS SKU_CONTRIBUTION_P3M_LP,
       (STORE_CONTRIBUTION_P3M_LP*SKU_CONTRIBUTION_P3M_LP*TOTAL_SALES_P3M_LP) AS SIZE_OF_PRICE_P3M_LP,
       (TOTAL_SALES_BY_STORE_P6M_LP / NULLIF(TOTAL_SALES_P6M_LP,0)) AS STORE_CONTRIBUTION_P6M_LP,
       (TOTAL_SALES_BY_SKU_P6M_LP / NULLIF(TOTAL_SALES_P6M_LP,0)) AS SKU_CONTRIBUTION_P6M_LP,
       (STORE_CONTRIBUTION_P6M_LP*SKU_CONTRIBUTION_P6M_LP*TOTAL_SALES_P6M_LP) AS SIZE_OF_PRICE_P6M_LP,
       (TOTAL_SALES_BY_STORE_P12M_LP / NULLIF(TOTAL_SALES_P12M_LP,0)) AS STORE_CONTRIBUTION_P12M_LP,
       (TOTAL_SALES_BY_SKU_P12M_LP / NULLIF(TOTAL_SALES_P12M_LP,0)) AS SKU_CONTRIBUTION_P12M_LP,
       (STORE_CONTRIBUTION_P12M_LP*SKU_CONTRIBUTION_P12M_LP*TOTAL_SALES_P12M_LP) AS SIZE_OF_PRICE_P12M_LP,
       MD5(soldto_code||DISTRIBUTOR_NAME||SELL_OUT_CHANNEL||RETAIL_ENVIRONMENT||nvl (CUSTOMER_SEGMENT_DESCRIPTION,'csd') || nvl (SAP_CUSTOMER_CHANNEL_DESCRIPTION,'sccd') ||nvl (SAP_SUB_CHANNEL_DESCRIPTION,'sscd') ||nvl (SAP_PARENT_CUSTOMER_DESCRIPTION,'spscd') || nvl (SAP_BANNER_DESCRIPTION,'sbd') || nvl (SAP_BANNER_FORMAT_DESCRIPTION,'sbfd')) AS CUSTOMER_AGG_DIM_KEY,
       MD5(nvl (SAP_BASE_PROD_DESC,'sbpd') || nvl (SAP_MEGA_BRND_DESC,'smbd') ||nvl (SAP_BRND_DESC,'sb') || nvl (SAP_FRNCHSE_DESC,'sfd') || nvl (SAP_PROD_MJR_DESC,'spmd') ||nvl (SAP_PROD_MNR_DESC,'spm') || nvl (PKA_FRANCHISE_DESC,'pfd') || nvl (PKA_BRAND_DESC,'pbd') ||nvl (PKA_SUB_BRAND_DESC,'pbsd') || nvl (GLOBAL_PRODUCT_FRANCHISE,'gpf') || nvl (GLOBAL_PRODUCT_BRAND,'gpb') ||nvl (GLOBAL_PRODUCT_SUB_BRAND,'gpsb') ||nvl (GLOBAL_PRODUCT_SEGMENT,'gps') || nvl (GLOBAL_PRODUCT_SUBSEGMENT,'gpss') ||nvl (GLOBAL_PRODUCT_CATEGORY,'gpc') ||nvl (GLOBAL_PRODUCT_SUBCATEGORY,'gpsc') ||nvl (GLOBAL_PUT_UP_DESCRIPTION,'gputup')) AS PRODUCT_AGG_DIM_KEY
FROM (SELECT MAIN.jj_year,
             MAIN.jj_mnth_id,
             "cluster",
             MAIN.MARKET AS MARKET,
             main.data_src,
             MAIN.CHANNEL_NAME AS CHANNEL_NAME,
             --MAIN.CHANNEL_NAME,
             MAIN.soldto_code,
             MAIN.DISTRIBUTOR_CODE,
             MAIN.DISTRIBUTOR_NAME,
             MAIN.SELL_OUT_CHANNEL,
             MAIN.STORE_TYPE AS STORE_TYPE,
             MAIN.PRIORITIZATION_SEGMENTATION,
             MAIN.STORE_CATEGORY,
             MAIN.STORE_CODE,
             MAIN.STORE_NAME,
             MAIN.STORE_GRADE,
             MAIN.STORE_SIZE,
             MAIN.REGION,
             MAIN.ZONE_NAME,
             MAIN.CITY,
             MAIN.RTRLATITUDE,
             MAIN.RTRLONGITUDE,
             TRIM(NVL (NULLIF(MAIN.CUSTOMER_SEGMENT_KEY,''),'NA')) AS CUSTOMER_SEGMENT_KEY,
             TRIM(NVL (NULLIF(MAIN.CUSTOMER_SEGMENT_DESCRIPTION,''),'NA')) AS CUSTOMER_SEGMENT_DESCRIPTION,
             main.sell_out_RE AS RETAIL_ENVIRONMENT,
             --TRIM(NVL (NULLIF(CUSTOMER.RETAIL_ENV,''),'NA')) AS RETAIL_ENVIRONMENT,
             TRIM(NVL (NULLIF(MAIN.SAP_CUSTOMER_CHANNEL_KEY,''),'NA')) AS SAP_CUSTOMER_CHANNEL_KEY,
             UPPER(TRIM(NVL (NULLIF(MAIN.SAP_CUSTOMER_CHANNEL_DESCRIPTION,''),'NA'))) AS SAP_CUSTOMER_CHANNEL_DESCRIPTION,
             TRIM(NVL (NULLIF(MAIN.SAP_CUSTOMER_SUB_CHANNEL_KEY,''),'NA')) AS SAP_CUSTOMER_SUB_CHANNEL_KEY,
             UPPER(TRIM(NVL (NULLIF(MAIN.SAP_SUB_CHANNEL_DESCRIPTION,''),'NA'))) AS SAP_SUB_CHANNEL_DESCRIPTION,
             TRIM(NVL (NULLIF(MAIN.SAP_PARENT_CUSTOMER_KEY,''),'NA')) AS SAP_PARENT_CUSTOMER_KEY,
             UPPER(TRIM(NVL (NULLIF(MAIN.SAP_PARENT_CUSTOMER_DESCRIPTION,''),'NA'))) AS SAP_PARENT_CUSTOMER_DESCRIPTION,
             TRIM(NVL (NULLIF(MAIN.SAP_BANNER_KEY,''),'NA')) AS SAP_BANNER_KEY,
             UPPER(TRIM(NVL (NULLIF(MAIN.SAP_BANNER_DESCRIPTION,''),'NA'))) AS SAP_BANNER_DESCRIPTION,
             TRIM(NVL (NULLIF(MAIN.SAP_BANNER_FORMAT_KEY,''),'NA')) AS SAP_BANNER_FORMAT_KEY,
             UPPER(TRIM(NVL (NULLIF(MAIN.SAP_BANNER_FORMAT_DESCRIPTION,''),'NA'))) AS SAP_BANNER_FORMAT_DESCRIPTION,
             TRIM(NVL (NULLIF(MAIN.CUSTOMER_NAME,''),'NA')) AS CUSTOMER_NAME,
             TRIM(NVL (NULLIF(MAIN.CUSTOMER_CODE,''),'NA')) AS CUSTOMER_CODE,
             MAIN.PRODUCT_CODE AS PRODUCT_CODE,
             MAIN.PRODUCT_NAME AS PRODUCT_NAME,
             MAIN.PROD_HIER_L1,
             MAIN.PROD_HIER_L2,
             MAIN.PROD_HIER_L3,
             MAIN.PROD_HIER_L4,
             MAIN.PROD_HIER_L5,
             MAIN.PROD_HIER_L6,
             MAIN.PROD_HIER_L7,
             MAIN.PROD_HIER_L8,
             MAIN.PROD_HIER_L9,
             MAIN.MAPPED_SKU_CD,
             MAIN.SAP_PROD_SGMT_CD,
             MAIN.SAP_PROD_SGMT_DESC,
             --PRODUCT.SAP_BASE_PROD_CD,
             MAIN.SAP_BASE_PROD_DESC,
             --PRODUCT.SAP_MEGA_BRND_CD,
             MAIN.SAP_MEGA_BRND_DESC,
             --PRODUCT.SAP_BRND_CD,
             MAIN.SAP_BRND_DESC,
             --PRODUCT.SAP_VRNT_CD,
             MAIN.SAP_VRNT_DESC,
             --PRODUCT.SAP_PUT_UP_CD,
             MAIN.SAP_PUT_UP_DESC,
             MAIN.SAP_GRP_FRNCHSE_CD,
             MAIN.SAP_GRP_FRNCHSE_DESC,
             MAIN.SAP_FRNCHSE_CD,
             MAIN.SAP_FRNCHSE_DESC,
             MAIN.SAP_PROD_FRNCHSE_CD,
             MAIN.SAP_PROD_FRNCHSE_DESC,
             MAIN.SAP_PROD_MJR_CD,
             MAIN.SAP_PROD_MJR_DESC,
             MAIN.SAP_PROD_MNR_CD,
             MAIN.SAP_PROD_MNR_DESC,
             MAIN.SAP_PROD_HIER_CD,
             MAIN.SAP_PROD_HIER_DESC,
             TRIM(NVL (NULLIF(MAIN.GLOBAL_PRODUCT_FRANCHISE,''),'NA')) AS GLOBAL_PRODUCT_FRANCHISE,
             TRIM(NVL (NULLIF(MAIN.GLOBAL_PRODUCT_BRAND,''),'NA')) AS GLOBAL_PRODUCT_BRAND,
             TRIM(NVL (NULLIF(MAIN.GLOBAL_PRODUCT_SUB_BRAND,''),'NA')) AS GLOBAL_PRODUCT_SUB_BRAND,
             TRIM(NVL (NULLIF(MAIN.GLOBAL_PRODUCT_VARIANT,''),'NA')) AS GLOBAL_PRODUCT_VARIANT,
             TRIM(NVL (NULLIF(MAIN.GLOBAL_PRODUCT_SEGMENT,''),'NA')) AS GLOBAL_PRODUCT_SEGMENT,
             TRIM(NVL (NULLIF(MAIN.GLOBAL_PRODUCT_SUBSEGMENT,''),'NA')) AS GLOBAL_PRODUCT_SUBSEGMENT,
             TRIM(NVL (NULLIF(MAIN.GLOBAL_PRODUCT_CATEGORY,''),'NA')) AS GLOBAL_PRODUCT_CATEGORY,
             TRIM(NVL (NULLIF(MAIN.GLOBAL_PRODUCT_SUBCATEGORY,''),'NA')) AS GLOBAL_PRODUCT_SUBCATEGORY,
             TRIM(NVL (NULLIF(MAIN.GLOBAL_PUT_UP_DESCRIPTION,''),'NA')) AS GLOBAL_PUT_UP_DESCRIPTION,
             --TRIM(NVL (NULLIF(PRODUCT.EAN_NUM,''),'NA')) AS EAN,
             --MAIN.PRODUCT_CODE AS SKU_CODE,
             -- LTRIM(PRODUCT.SAP_MATL_NUM,0) AS SKU_CODE,
             UPPER(MAIN.SKU_DESCRIPTION) AS SKU_DESCRIPTION,
             --TRIM(NVL (NULLIF(PRODUCT.GREENLIGHT_SKU_FLAG,''),'NA')) AS GREENLIGHT_SKU_FLAG,
             TRIM(NVL (NULLIF(MAIN.PKA_PRODUCT_KEY,''),'NA')) AS PKA_PRODUCT_KEY,
             TRIM(NVL (NULLIF(MAIN.PKA_PRODUCT_KEY_DESCRIPTION,''),'NA')) AS PKA_PRODUCT_KEY_DESCRIPTION,
             --PRODUCT.PKA_FRANCHISE_CD,
             MAIN.PKA_FRANCHISE_DESC,
             --PRODUCT.PKA_BRAND_CD,
             MAIN.PKA_BRAND_DESC,
             --PRODUCT.PKA_SUB_BRAND_CD,
             MAIN.PKA_SUB_BRAND_DESC,
             --PRODUCT.PKA_VARIANT_CD,
             MAIN.PKA_VARIANT_DESC,
             --PRODUCT.PKA_SUB_VARIANT_CD,
             MAIN.PKA_SUB_VARIANT_DESC,
             MAIN.SALES_VALUE AS SALES_VALUE,
             MAIN.SALES_QTY AS SALES_QTY,
             MAIN.AVG_SALES_QTY AS AVG_SALES_QTY,
             MAIN.SALES_VALUE_LIST_PRICE AS SALES_VALUE_LIST_PRICE,
             MAIN.LM_SALES AS LM_SALES,
             MAIN.LM_SALES_QTY AS LM_SALES_QTY,
             MAIN.LM_AVG_SALES_QTY AS LM_AVG_SALES_QTY,
             MAIN.LM_SALES_LP AS LM_SALES_LP,
             MAIN.P3M_SALES AS P3M_SALES,
             MAIN.P3M_QTY AS P3M_QTY,
             MAIN.P3M_AVG_QTY AS P3M_AVG_QTY,
             MAIN.P3M_SALES_LP AS P3M_SALES_LP,
             MAIN.F3M_SALES AS F3M_SALES,
             MAIN.F3M_QTY AS F3M_QTY,
             MAIN.F3M_AVG_QTY AS F3M_AVG_QTY,
             MAIN.P6M_SALES AS P6M_SALES,
             MAIN.P6M_QTY AS P6M_QTY,
             MAIN.P6M_AVG_QTY AS P6M_AVG_QTY,
             MAIN.P6M_SALES_LP AS P6M_SALES_LP,
             MAIN.P12M_SALES AS P12M_SALES,
             MAIN.P12M_QTY AS P12M_QTY,
             MAIN.P12M_AVG_QTY AS P12M_AVG_QTY,
             MAIN.P12M_SALES_LP AS P12M_SALES_LP,
             MAIN.LM_SALES_FLAG,
             MAIN.P3M_SALES_FLAG,
             MAIN.P6M_SALES_FLAG,
             MAIN.P12M_SALES_FLAG,
             MAIN.MDP_FLAG,
             1 AS TARGET_COMPLAINCE,
             MAIN.LIST_PRICE,
             SUM(MAIN.LM_SALES) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND) AS TOTAL_SALES_LM,
             SUM(MAIN.P3M_SALES) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND) AS TOTAL_SALES_P3M,
             SUM(MAIN.P6M_SALES) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND) AS TOTAL_SALES_P6M,
             SUM(MAIN.P12M_SALES) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND) AS TOTAL_SALES_P12M,
             SUM(MAIN.LM_SALES) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND,STORE_CODE) AS TOTAL_SALES_BY_STORE_LM,
             SUM(MAIN.P3M_SALES) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND,STORE_CODE) AS TOTAL_SALES_BY_STORE_P3M,
             SUM(MAIN.P6M_SALES) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND,STORE_CODE) AS TOTAL_SALES_BY_STORE_P6M,
             SUM(MAIN.P12M_SALES) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND,STORE_CODE) AS TOTAL_SALES_BY_STORE_P12M,
             SUM(MAIN.LM_SALES) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND,PRODUCT_CODE) AS TOTAL_SALES_BY_SKU_LM,
             SUM(MAIN.P3M_SALES) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND,PRODUCT_CODE) AS TOTAL_SALES_BY_SKU_P3M,
             SUM(MAIN.P6M_SALES) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND,PRODUCT_CODE) AS TOTAL_SALES_BY_SKU_P6M,
             SUM(MAIN.P12M_SALES) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND,PRODUCT_CODE) AS TOTAL_SALES_BY_SKU_P12M,
             SUM(MAIN.LM_SALES_LP) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND) AS TOTAL_SALES_LM_LP,
             SUM(MAIN.P3M_SALES_LP) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND) AS TOTAL_SALES_P3M_LP,
             SUM(MAIN.P6M_SALES_LP) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND) AS TOTAL_SALES_P6M_LP,
             SUM(MAIN.P12M_SALES_LP) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND) AS TOTAL_SALES_P12M_LP,
             SUM(MAIN.LM_SALES_LP) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND) AS TOTAL_SALES_BY_STORE_LM_LP,
             SUM(MAIN.P3M_SALES_LP) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND) AS TOTAL_SALES_BY_STORE_P3M_LP,
             SUM(MAIN.P6M_SALES_LP) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND) AS TOTAL_SALES_BY_STORE_P6M_LP,
             SUM(MAIN.P12M_SALES_LP) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND) AS TOTAL_SALES_BY_STORE_P12M_LP,
             SUM(MAIN.LM_SALES_LP) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND) AS TOTAL_SALES_BY_SKU_LM_LP,
             SUM(MAIN.P3M_SALES_LP) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND) AS TOTAL_SALES_BY_SKU_P3M_LP,
             SUM(MAIN.P6M_SALES_LP) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND) AS TOTAL_SALES_BY_SKU_P6M_LP,
             SUM(MAIN.P12M_SALES_LP) OVER (PARTITION BY jj_mnth_id,DISTRIBUTOR_NAME,GLOBAL_PRODUCT_BRAND) AS TOTAL_SALES_BY_SKU_P12M_LP
      FROM WKS_TW_RPT_RE MAIN
        )
);
